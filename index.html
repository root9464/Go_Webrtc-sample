<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <h3>Local Video</h3>
    <video id="localVideo" width="160" height="120" autoplay muted></video> <br />

    <h3>Remote Video</h3>
    <div id="remoteVideos"></div>
    <br />

    <h3>Logs</h3>
    <div id="logs"></div>
  </body>

  <script>
    // Функция для инициализации WebRTC-соединения
    function initPeerConnection() {
      let pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
      });

      pc.ontrack = function (event) {
        if (event.track.kind === 'audio') {
          return;
        }

        let el = document.createElement(event.track.kind);
        el.srcObject = event.streams[0];
        el.autoplay = true;
        el.controls = true;
        document.getElementById('remoteVideos').appendChild(el);

        event.track.onmute = function () {
          el.play();
        };

        event.streams[0].onremovetrack = ({ track }) => {
          if (el.parentNode) {
            el.parentNode.removeChild(el);
          }
        };
      };

      pc.oniceconnectionstatechange = function () {
        console.log('ICE connection state:', pc.iceConnectionState);
        if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
          console.log('ICE connection failed or disconnected, attempting to reconnect');
          reconnect();
        }
      };

      return pc;
    }

    // Функция для настройки WebSocket
    function setupWebSocket(pc) {
      let ws = new WebSocket('ws://localhost:8080/websocket');

      pc.onicecandidate = (e) => {
        if (!e.candidate) {
          return;
        }
        ws.send(JSON.stringify({ event: 'candidate', data: JSON.stringify(e.candidate) }));
      };

      ws.onclose = function () {
        console.log('WebSocket closed, attempting to reconnect');
        reconnect();
      };

      ws.onmessage = function (evt) {
        let msg;
        try {
          msg = JSON.parse(evt.data);
        } catch (e) {
          console.log('Failed to parse msg:', e);
          return;
        }

        switch (msg.event) {
          case 'offer':
            let offer;
            try {
              offer = JSON.parse(msg.data);
            } catch (e) {
              console.log('Failed to parse offer:', e);
              return;
            }
            pc.setRemoteDescription(offer)
              .then(() => pc.createAnswer())
              .then((answer) => pc.setLocalDescription(answer))
              .then(() => {
                ws.send(JSON.stringify({ event: 'answer', data: JSON.stringify(pc.localDescription) }));
              })
              .catch((e) => console.log('Error handling offer:', e));
            break;

          case 'candidate':
            let candidate;
            try {
              candidate = JSON.parse(msg.data);
            } catch (e) {
              console.log('Failed to parse candidate:', e);
              return;
            }
            pc.addIceCandidate(candidate).catch((e) => console.log('Error adding ICE candidate:', e));
            break;
        }
      };

      ws.onerror = function (evt) {
        console.log('WebSocket error:', evt);
      };

      return ws;
    }

    // Функция для повторного подключения
    function reconnect() {
      setTimeout(() => {
        console.log('Attempting to reconnect...');
        initConnection();
      }, 1000);
    }

    // Основная функция для инициализации соединения
    function initConnection() {
      let pc = initPeerConnection();
      let ws = setupWebSocket(pc);

      // Запрашиваем доступ к камере/микрофону, но делаем это опциональным
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          document.getElementById('localVideo').srcObject = stream;
          stream.getTracks().forEach((track) => pc.addTrack(track, stream));
          console.log('Local stream added');
        })
        .catch((e) => {
          console.log('No local stream available (camera/microphone disabled):', e);
        });
    }

    // Запускаем соединение
    initConnection();
  </script>
</html>
